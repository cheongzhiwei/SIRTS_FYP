{% extends 'base.html' %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card shadow-sm border-0 mt-5">
            <div class="card-header bg-primary text-white py-3">
                <h4 class="mb-0 text-center">New Incident Report</h4>
            </div>
            <div class="card-body p-4">
                <form id="incidentForm" method="POST">
                    {% csrf_token %}

                    <div class="mb-4">
                        <label class="form-label fw-bold fs-5">What is the issue? (e.g. Printer jam, Wifi slow)</label>
                        <input type="text" id="issueTitle" name="title" class="form-control form-control-lg border-2" 
                               placeholder="Type issue here..." required onkeyup="scanKeywords()">
                        <div class="form-text mt-2">The system will scan for keywords to suggest a quick fix.</div>
                    </div>

                    <div id="solutionHub" class="card bg-light border-warning mb-4 d-none">
                        <div class="card-body">
                            <h5 class="text-warning mb-3">ðŸ’¡ Quick Fixes: Try these first</h5>
                            <ul id="suggestionList" class="mb-4 fw-bold text-dark fs-6">
                                </ul>
                            
                            <div class="d-grid">
                                <button type="button" id="ackBtn" class="btn btn-warning btn-lg fw-bold shadow-sm" onclick="enableSubmission()">
                                    âœ… I have checked these steps but the issue remains
                                </button>
                            </div>
                        </div>
                    </div>

                    <div id="actionButtons" class="d-none border-top pt-4">
                        <div class="text-center mb-4">
                            <p class="text-muted">If the steps didn't work, click <strong>Submit Ticket</strong>. If you fixed it, click <strong>Issue Solved</strong>.</p>
                        </div>
                        <div class="d-flex justify-content-between gap-3">
                            <button type="button" class="btn btn-success btn-lg flex-fill shadow-sm" onclick="submitAsSelfFixed()">
                                ðŸŽ‰ Issue Solved
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg flex-fill shadow-sm">
                                ðŸ“© Submit Ticket
                            </button>
                        </div>
                    </div>

                    <input type="hidden" name="status" id="statusInput" value="Open">
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    // These are the finalized rules you approved
    const rules = [
        { 
            keywords: ['wifi', 'internet', 'net', 'network', 'vpn'], 
            suggestions: ['Turn Airplane Mode ON then OFF.', 'Check if you are on the CORRECT network.'] 
        },
        { 
            keywords: ['print', 'printer', 'paper', 'jam'], 
            suggestions: ['Check for a "Paper Jam" error.', 'Check "Printer Properties" tray settings.', 'Ensure you chose the CORRECT printer name.'] 
        },
        { 
            keywords: ['lag', 'slow', 'freeze', 'hang', 'app'], 
            suggestions: ['Close unused apps.', 'Restart the specific app.', 'Turn laptop OFF then ON.'] 
        },
        { 
            keywords: ['screen', 'mouse', 'keyboard', 'hardware', 'monitor'], 
            suggestions: ['Unplug and plug it back in.', 'Restart your laptop.', 'Try a different USB port.'] 
        },
        { 
            keywords: ['charger', 'battery', 'cable', 'power', 'plug'], 
            suggestions: ['Check if the charging light is ON.', 'Push the cables in firmly.', 'Try a different wall socket.'] 
        }
    ];

    function scanKeywords() {
        const title = document.getElementById('issueTitle').value.toLowerCase();
        const hub = document.getElementById('solutionHub');
        const list = document.getElementById('suggestionList');
        const actions = document.getElementById('actionButtons');
        
        let found = false;
        list.innerHTML = '';

        // Only scan if title has at least 3 characters
        if (title.length > 2) {
            rules.forEach(rule => {
                if (rule.keywords.some(k => title.includes(k))) {
                    rule.suggestions.forEach(s => {
                        list.innerHTML += `<li class="mb-2">${s}</li>`;
                    });
                    found = true;
                }
            });
        }

        if (found) {
            hub.classList.remove('d-none');
            actions.classList.add('d-none'); // Hide buttons until they acknowledge
        } else {
            hub.classList.add('d-none');
            // If no keywords found, show submission buttons immediately
            actions.classList.remove('d-none');
        }
    }

    function enableSubmission() {
        document.getElementById('ackBtn').classList.add('d-none');
        document.getElementById('actionButtons').classList.remove('d-none');
    }

    function submitAsSelfFixed() {
        document.getElementById('statusInput').value = 'Resolved';
        document.getElementById('incidentForm').submit();
    }
</script>
{% endblock %}