{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">Admin Dashboard</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <a href="/admin/" class="btn btn-sm btn-outline-secondary">⚙️ User Management</a>
        </div>
    </div>

    <div class="row g-2 mb-4">
        
        <div class="col">
            <a href="?status=Open" class="text-decoration-none">
                <div class="card text-white bg-danger h-100 shadow-sm hover-card text-center">
                    <div class="card-body py-2">
                        <small>OPEN</small>
                        <h3 class="fw-bold m-0">{{ count_open }}</h3>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="?status=Resolved" class="text-decoration-none">
                <div class="card text-white bg-primary h-100 shadow-sm hover-card text-center">
                    <div class="card-body py-2">
                        <small>SELF FIXED</small>
                        <h3 class="fw-bold m-0">{{ count_self_fixed }}</h3>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="?status=Closed" class="text-decoration-none">
                <div class="card text-white bg-success h-100 shadow-sm hover-card text-center">
                    <div class="card-body py-2">
                        <small>CLOSE</small>
                        <h3 class="fw-bold m-0">{{ count_closed }}</h3>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="?status=Open" class="text-decoration-none">
                <div class="card text-dark bg-warning h-100 shadow-sm hover-card text-center">
                    <div class="card-body py-2">
                        <small>OPEN (YEAR)</small>
                        <h3 class="fw-bold m-0">{{ count_year_open }}</h3>
                    </div>
                </div>
            </a>
        </div>

        <div class="col">
            <a href="?" class="text-decoration-none">
                <div class="card text-white bg-secondary h-100 shadow-sm hover-card text-center">
                    <div class="card-body py-2">
                        <small>TOTAL TICKETS</small>
                        <h3 class="fw-bold m-0">{{ total_all }}</h3>
                    </div>
                </div>
            </a>
        </div>
    </div>

    <div class="card mb-4 bg-light border-0">
        <div class="card-body p-3">
            <form method="get" class="row g-2 align-items-end">
                
                <div class="col-md-auto">
                    <label class="form-label small fw-bold text-muted">Time Period</label><br>
                    <div class="btn-group" role="group">
                        <button type="submit" name="date_range" value="today" class="btn btn-sm btn-outline-primary {% if current_date_range == 'today' %}active{% endif %}">Today</button>
                        <button type="submit" name="date_range" value="week" class="btn btn-sm btn-outline-primary {% if current_date_range == 'week' %}active{% endif %}">Week</button>
                        <button type="submit" name="date_range" value="month" class="btn btn-sm btn-outline-primary {% if current_date_range == 'month' %}active{% endif %}">Month</button>
                        <button type="submit" name="date_range" value="all" class="btn btn-sm btn-outline-primary {% if current_date_range == 'all' %}active{% endif %}">All</button>
                    </div>
                </div>

                <div class="col-md-auto">
                    <label class="form-label small fw-bold text-muted">From</label>
                    <input type="date" name="date_from" class="form-control form-control-sm">
                </div>
                <div class="col-md-auto">
                    <label class="form-label small fw-bold text-muted">To</label>
                    <input type="date" name="date_to" class="form-control form-control-sm">
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Status</label>
                    <select name="status" class="form-select form-select-sm">
                        <option value="">All Statuses</option>
                        <option value="Open">Open</option>
                        <option value="Resolved">Self Fixed</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>

                <div class="col-md-2">
                    <label class="form-label small fw-bold text-muted">Department</label>
                    <select name="department" class="form-select form-select-sm">
                        <option value="">All Depts</option>
                        {% for code, name in dept_choices %}
                            <option value="{{ code }}">{{ name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-auto">
                    <label class="form-label small fw-bold text-muted">Laptop Model</label>
                    <input type="text" name="laptop" class="form-control form-control-sm" placeholder="e.g. Dell">
                </div>

                <div class="col-md-auto">
                    <label class="form-label small fw-bold text-muted">Username</label>
                    <input type="text" name="reporter" class="form-control form-control-sm" placeholder="e.g. alice">
                </div>

                <div class="col-md-auto">
                    <button type="submit" class="btn btn-sm btn-primary w-100">Filter</button>
                </div>
                <div class="col-md-auto">
                    <a href="{% url 'admin_dashboard' %}" class="btn btn-sm btn-secondary w-100">Reset</a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-header bg-white py-3 d-flex justify-content-between">
            <h5 class="mb-0">Ticket List</h5>
            <span class="badge bg-light text-dark border">Showing: {{ tickets.count }} tickets</span>
        </div>
        
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">ID</th>
                            <th>Username</th>
                            <th>Dept</th>
                            <th>Laptop</th>
                            <th>Issue Title</th>
                            <th>Date Reported</th>
                            <th>Status</th>
                            <th class="text-end pe-3">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for ticket in tickets %}
                        <tr>
                            <td class="ps-3 fw-bold">#{{ ticket.id }}</td>
                            
                            <td>
                                <div class="fw-bold">
                                    {% if ticket.user.username %}
                                        {{ ticket.user.username }}
                                    {% elif ticket.reporter_name %}
                                        {{ ticket.reporter_name }}
                                    {% else %}
                                        -
                                    {% endif %}
                                </div>
                                <div class="small text-muted">{{ ticket.email|default:"-" }}</div>
                            </td>

                            <td>
                                {% if ticket.department %}
                                    <span class="badge bg-secondary">{{ ticket.department }}</span>
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>

                            <td>
                                {% if ticket.user.employeeprofile.laptop_model %}
                                    <span class="text-dark">{{ ticket.user.employeeprofile.laptop_model }}</span>
                                {% else %}
                                    <span class="text-muted small">-</span>
                                {% endif %}
                            </td>

                            <td>{{ ticket.title }}</td>
                            <td>{{ ticket.created_at|date:"d/m/Y" }}</td>
                            
                            <td>
                                {% if ticket.status == 'Open' %}
                                    <span class="badge bg-danger">Open</span> {% elif ticket.status == 'Resolved' or ticket.status == 'Self Fixed' or ticket.status == 'Self-Fixed' %}
                                    <span class="badge bg-primary">Self Fixed</span> {% elif ticket.status == 'Closed' %}
                                    <span class="badge bg-success">Closed</span> {% else %}
                                    <span class="badge bg-secondary">{{ ticket.status }}</span> {% endif %}
                            </td>

                            <td class="text-end pe-3">
                                <a href="{% url 'manage_ticket' ticket.id %}" class="btn btn-sm btn-primary">Manage</a>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                No tickets found for this filter.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<style>
    .hover-card:hover { transform: translateY(-3px); transition: 0.2s; opacity: 0.9; cursor: pointer; }
</style>
{% endblock %}